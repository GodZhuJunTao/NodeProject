<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/register.css">
    <title>登录</title>
</head>

<body>
    <div id="register">
        <div class="register">
            <img src="assets/微信截图_20181213192717_r2_c2.png" alt="">
            <div class="box1">
                <img src="assets/yonghu.png" alt=""><input type="text" placeholder="请输入用户名" id="user">
            </div>

            <div class="box1">
                <img src="assets/mima.png" alt=""><input type="password" placeholder="请输入密码" id="password">
            </div>
            <div class="box2">
                <div class="box_l">
                    <img src="assets/anquan.png" alt=""><input type="text" class="bk-default kd80 code_val" id="code"
                        placeholder="图形验证码">
                </div>

                <div id="picCode">
                    <span></span>
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="code">验证码错误</div>
            </div>

            <div class="box3">
                <input type="checkbox">记住密码<a href="">忘记密码</a>
            </div>
            <div class="box4">
                <a href="javascript:;">登入</a>
            </div>
        </div>
    </div>
</body>
<script src="lib/jquery-1.10.1.min.js"></script>
<script src="js/register.js"></script>
<script>
    document.addEventListener('DOMContentLoaded',()=>{
        let login = document.querySelector('.box4');
        let user = document.querySelector('#user');
        let password = document.querySelector('#password');
        let code = document.querySelector('#code');
        let divCode = document.querySelector('.code');
        let span = document.querySelectorAll('#picCode span');
        let status = [200,304];
        let isok = false;
        code.onblur = ()=>{
            isok = false;
            var str = '';
            for(var i=0;i<4;i++){
                str+=span[i].innerHTML;
            }
            var _code = code.value;
            _code = _code.toLowerCase(_code);
            str = str.toLowerCase(str);
            if(_code == str){
                divCode.innerHTML = '验证码正确';
                divCode.style.color = 'green';
                divCode.style.display = 'block';
                isok = true;
            }else{
                divCode.innerHTML = '验证码错误';
                divCode.style.color = 'red';
                divCode.style.display = 'block';
            }
        }
        login.onclick = ()=>{
            if(isok){
                let _user = user.value;
                let _password = password.value;
                let _code = code.value;
                let xhr = new XMLHttpRequest();
                xhr.open('post','/login',true);
                xhr.onload = ()=>{
                    if(status.includes(xhr.status)){
                        let res = JSON.parse(xhr.responseText);
                        if(res.code == 1){
                            location.href = 'html/center.html';
                        }else{
                            alert('用户名或密码错误');
                        }
                    }
                }
                xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');
                xhr.send(`username=${_user}&password=${_password}`);
            }
        }
    })
</script>
</html>